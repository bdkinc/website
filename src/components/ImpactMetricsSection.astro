---
import type { LucideIcon } from 'lucide-react';
import MetricCountUp from './MetricCountUp';

interface Metric {
  value: string;
  label: string;
  icon?: LucideIcon;
}

interface Props {
  metrics: Metric[];
  title?: string;
  eyebrow?: string;
  description?: string;
}

const { metrics, title = 'Impact Metrics', eyebrow, description } = Astro.props;
---

{
  metrics.length > 0 && (
    <section class="mb-20 px-4 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-7xl">
        <div class="border-border/60 bg-background/80 relative overflow-hidden rounded-3xl border p-10 shadow-[--shadow-glow-sm] sm:p-12 lg:p-16">
          <div
            class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,#00d4ff33,transparent_65%)]"
            aria-hidden="true"
          />
          <div
            class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,#7c3aed2b,transparent_60%)]"
            aria-hidden="true"
          />

          <div class="relative z-10 flex flex-col gap-10">
            <div class="text-center">
              {eyebrow && (
                <p class="text-primary mb-3 text-xs font-semibold tracking-[0.4em] uppercase">
                  {eyebrow}
                </p>
              )}
              <h3 class="text-foreground text-3xl font-bold md:text-4xl">
                {title}
              </h3>
              {description && (
                <p class="text-muted-foreground mx-auto mt-4 max-w-2xl text-base md:text-lg">
                  {description}
                </p>
              )}
            </div>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
              {metrics.map((metric, index) => (
                <div
                  class="impact-metric-card group border-border/60 bg-background/90 relative overflow-hidden rounded-2xl border p-8 text-center transition-transform duration-500 ease-out hover:-translate-y-1"
                  data-delay={index * 80}
                >
                  <div
                    class="metric-card-glow from-primary/20 pointer-events-none absolute inset-0 bg-linear-to-br via-transparent to-transparent opacity-0 transition-opacity duration-700 group-hover:opacity-100"
                    aria-hidden="true"
                  />
                  <div class="relative z-10 flex flex-col items-center gap-4">
                    {metric.icon && (
                      <div class="bg-primary/10 text-primary flex h-16 w-16 items-center justify-center rounded-full">
                        <metric.icon className="h-8 w-8" aria-hidden="true" />
                      </div>
                    )}
                    <div class="metric-value">
                      <MetricCountUp client:visible value={metric.value} label={metric.label} />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
  )
}

<script type="module" is:inline>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  if (typeof window !== 'undefined') {
    const setupImpactMetrics = () => {
      const cards = document.querySelectorAll('.impact-metric-card');
      if (!cards.length) {
        return;
      }

      const prefersReducedMotion = window.matchMedia(
        '(prefers-reduced-motion: reduce)'
      ).matches;
      if (prefersReducedMotion) {
        return;
      }

      gsap.registerPlugin(ScrollTrigger);

      cards.forEach((card, index) => {
        const delay = Number(card.dataset.delay ?? '0') / 1000;
        const valueEl = card.querySelector('.metric-value');
        const glowEl = card.querySelector('.metric-card-glow');

        ScrollTrigger.create({
          trigger: card,
          start: 'top 80%',
          once: true,
          onEnter: () => {
            gsap.fromTo(
              card,
              { opacity: 0, y: 32 },
              { opacity: 1, y: 0, delay, duration: 0.8, ease: 'power3.out' }
            );

            if (valueEl) {
              gsap.fromTo(
                valueEl,
                { scale: 0.9 },
                {
                  scale: 1,
                  delay: delay + 0.12,
                  duration: 0.6,
                  ease: 'back.out(1.7)',
                }
              );
            }

            if (glowEl) {
              gsap.fromTo(
                glowEl,
                { opacity: 0 },
                { opacity: 0.55, delay, duration: 1.2, ease: 'power2.out' }
              );
            }
          },
        });
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupImpactMetrics, {
        once: true,
      });
    } else {
      setupImpactMetrics();
    }
  }
</script>
