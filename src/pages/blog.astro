---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation';
import CTASection from '@/components/CTASection';
import { getCollection } from 'astro:content';
import { Calendar, User, Tag } from 'lucide-react';
import { Card } from '@/components/ui/card';
import { getNavigationData } from '@/lib/navigation-data';
import { Logo } from '@/components/Logo';
import Footer from '@/components/Footer.astro';

const { servicesData, recentPosts } = await getNavigationData();

// Get all blog posts, sorted by date (newest first), exclude drafts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Format date helper
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}
---

<Layout title="Blog - BDKinc">
  <Navigation
    client:load
    services={servicesData}
    blogPosts={recentPosts}
    currentPath={Astro.url.pathname}
  />
  <main id="main-content">
    <!-- Hero Section -->
    <section class="relative overflow-hidden px-4 pt-24 pb-12 sm:px-6 lg:px-8">
      <div class="gradient-mesh absolute inset-0 opacity-30"></div>
      <div class="circuit-overlay absolute inset-0 opacity-40"></div>
      <div class="relative z-10 mx-auto max-w-7xl text-center">
        <h1
          class="fill-mode-both animate-in fade-in slide-in-from-top-6 mb-6 text-5xl font-bold duration-700 md:text-7xl"
        >
          <span class="text-foreground">Our </span>
          <span class="text-primary"> Blog </span>
        </h1>
        <p
          class="text-muted-foreground fill-mode-both animate-in fade-in slide-in-from-bottom-4 mx-auto max-w-5xl text-xl delay-200 duration-600 md:text-2xl"
        >
          Insights, tips, and best practices for modern IT infrastructure and
          management
        </p>
      </div>
      <div
        class="from-brand-primary to-brand-secondary absolute right-0 bottom-0 left-0 h-2 bg-linear-to-br"
      >
      </div>
    </section>

    <!-- Blog Posts Grid -->
    <section class="px-4 py-24 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-7xl">
        <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3">
          {
            sortedPosts.map((post, index) => {
              // Calculate stagger delay: 80ms between cards (reading order: left-to-right, top-to-bottom)
              const column = index % 3;
              const row = Math.floor(index / 3);
              const delayMs = 150 + column * 60 + row * 100;
              const tags = post.data.tags ?? [];
              const hasTags = tags.length > 0;

              return (
                <a
                  href={`/blog/${post.slug}`}
                  class="group fill-mode-both animate-in fade-in slide-in-from-bottom-6 block duration-600"
                  style={{ animationDelay: `${delayMs}ms` }}
                >
                  <Card
                    size="default"
                    interactive={true}
                    className="h-full flex flex-col"
                  >
                    <div class="mb-4">
                      <div class="text-muted-foreground mb-4 flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1">
                          <Calendar className="w-4 h-4" />
                          <time datetime={post.data.pubDate.toISOString()}>
                            {formatDate(post.data.pubDate)}
                          </time>
                        </div>
                        <div class="flex items-center gap-1">
                          <User className="w-4 h-4" />
                          <span>{post.data.author}</span>
                        </div>
                      </div>
                      <h2
                        transition:name={`blog-title-${post.slug}`}
                        transition:animate="initial"
                        class="group-hover:text-primary mb-3 text-2xl leading-none font-semibold tracking-tight transition-colors duration-300"
                      >
                        {post.data.title}
                      </h2>
                      <p
                        transition:name={`blog-description-${post.slug}`}
                        transition:animate="initial"
                        class="text-muted-foreground text-sm"
                      >
                        {post.data.description}
                      </p>
                    </div>

                    <div class="mt-auto">
                      {hasTags && (
                        <div class="mb-4 flex flex-wrap gap-2">
                          {tags.map((tag, tagIndex) => (
                            <span
                              class="bg-primary/10 text-primary fill-mode-both animate-in fade-in slide-in-from-left-2 inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium duration-500"
                              style={{
                                animationDelay: `${delayMs + tagIndex * 50}ms`,
                              }}
                            >
                              <Tag className="w-3 h-3" />
                              {tag}
                            </span>
                          ))}
                        </div>
                      )}

                      <div class="text-primary flex items-center font-medium transition-all duration-300 group-hover:gap-2">
                        Read More
                        <svg
                          class="ml-1 h-4 w-4 transition-transform duration-300 group-hover:translate-x-1"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5l7 7-7 7"
                          />
                        </svg>
                      </div>
                    </div>
                  </Card>
                </a>
              );
            })
          }
        </div>

        {
          sortedPosts.length === 0 && (
            <div class="py-12 text-center">
              <p class="text-muted-foreground text-xl">
                No blog posts available yet. Check back soon!
              </p>
            </div>
          )
        }
      </div>
    </section>

    <!-- CTA Section -->
    <CTASection
      client:visible
      title="Stay Updated with IT Insights"
      description="Want to discuss how these insights can help your business? Let's talk."
      buttonText="Get in Touch"
      buttonHref="/contact?from=blog"
    />
  </main>

  <Footer />
</Layout>
