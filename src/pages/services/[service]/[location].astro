---
import { getEntry, getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Navigation from '../../../components/Navigation';
import { getNavigationData } from '@/lib/navigation-data';
import { iconMap } from '@/lib/icons';
import { getLocationBySlug } from '@/lib/locations';
import {
  MapPin,
  Phone,
  Mail,
  Clock,
  Users,
  CheckCircle,
  Shield,
  TrendingUp,
} from 'lucide-react';
import { Card } from '@/components/ui/card';
import { Logo } from '@/components/Logo';

export async function getStaticPaths() {
  // Get main services, PSEO services, and locations from collections
  const mainServices = await getCollection('services');
  const pseoServices = await getCollection('pseoServices');
  const locations = await getCollection('locations');
  const paths = [];

  for (const svc of mainServices) {
    for (const location of locations) {
      const locationSlug = location.data.name
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/,/g, '');

      paths.push({
        params: {
          service: svc.id,
          location: locationSlug,
        },
        props: {
          serviceSlug: svc.id,
          locationSlug,
          collectionKey: 'services' as const,
        },
      });
    }
  }

  for (const svc of pseoServices) {
    for (const location of locations) {
      const locationSlug = location.data.name
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/,/g, '');

      paths.push({
        params: {
          service: svc.id,
          location: locationSlug,
        },
        props: {
          serviceSlug: svc.id,
          locationSlug,
          collectionKey: 'pseoServices' as const,
        },
      });
    }
  }

  return paths;
}

const { serviceSlug, locationSlug, collectionKey } = Astro.props;

const locationData = getLocationBySlug(locationSlug);
if (!locationData) {
  return new Response(null, { status: 404 });
}

// Get service data from the correct collection to avoid warnings
const service = await getEntry(collectionKey, serviceSlug);
if (!service) {
  return new Response(null, { status: 404 });
}

const { servicesData, recentPosts } = await getNavigationData();
const IconComponent = iconMap[service.data.icon];

// Location-specific content
const locationIntro = `As a leading Managed Service Provider serving ${locationData.name}, ${locationData.state}, BDKinc delivers comprehensive ${service.data.title.toLowerCase()} solutions tailored to local businesses. Our team understands the unique technology challenges faced by companies in the ${locationData.region} region.`;

const locationFeatures = [
  {
    icon: MapPin,
    title: 'Local Expertise',
    description: `Deep understanding of ${locationData.name}'s business landscape and regulatory environment`,
  },
  {
    icon: Clock,
    title: 'Rapid Response',
    description: 'Average response time under 2 hours for critical issues',
  },
  {
    icon: Shield,
    title: 'Proactive Monitoring',
    description: '24/7/365 system monitoring and preventive maintenance',
  },
  {
    icon: Users,
    title: 'Dedicated Team',
    description:
      'Assigned technician who knows your business and infrastructure',
  },
];

const locations = await getCollection('locations');
const nearbyLocations = locations
  .filter(
    (loc) =>
      loc.data.name !== locationData.name &&
      loc.data.state === locationData.state
  )
  .slice(0, 3);

const pageDescription = `${service.data.title} in ${locationData.name}, ${locationData.state}. Local MSP services with 24/7 support, proactive monitoring, and customizable solutions for ${locationData.region} businesses.`;
---

<Layout
  title={`${service.data.title} in ${locationData.name}, ${locationData.state} | BDKinc`}
  description={pageDescription}
>
  <Navigation
    client:load
    services={servicesData}
    blogPosts={recentPosts}
    currentPath={Astro.url.pathname}
  />
  <main id="main-content">
    <!-- Hero Section with Location -->
    <section class="relative overflow-hidden px-4 pt-24 pb-12 sm:px-6 lg:px-8">
      <div class="gradient-mesh absolute inset-0 opacity-30"></div>
      <div class="circuit-overlay absolute inset-0 opacity-40"></div>
      <div class="relative z-10 mx-auto max-w-7xl text-center">
        <div class="mb-6 inline-flex items-center justify-center gap-2 text-lg">
          <MapPin className="text-primary h-5 w-5" />
          <span class="text-muted-foreground"
            >${locationData.name}, ${locationData.state}</span
          >
        </div>
        <div
          class="bg-linear-tobr from-primary/10 to-secondary/10 mb-6 inline-flex items-center justify-center rounded-2xl p-4"
        >
          <IconComponent className="text-primary h-12 w-12" />
        </div>
        <h1 class="mb-6 text-5xl font-bold md:text-6xl">
          <span class="text-foreground">${service.data.title}</span>
          <br />
          <span class="text-primary">${locationData.name}</span>
        </h1>
        <p class="text-muted-foreground mx-auto max-w-3xl text-xl">
          {locationIntro}
        </p>
        <div class="mt-8 flex flex-col items-center gap-4 sm:flex-row">
          <a
            href="/contact"
            class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex cursor-pointer items-center gap-2 rounded-md px-8 py-3 text-sm font-medium shadow-sm transition-colors duration-300 hover:shadow-[--shadow-glow-sm]"
          >
            Get Started Today
            <Phone className="h-4 w-4" />
          </a>
          <a
            href="tel:410-555-0123"
            class="text-muted-foreground hover:text-foreground inline-flex items-center gap-2 text-sm transition-colors"
          >
            <Phone className="h-4 w-4" />
            (410) 555-0123
          </a>
        </div>
      </div>
    </section>

    <!-- Location-Specific Features -->
    <section class="px-4 py-16 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-7xl">
        <h2
          class="text-foreground mb-12 text-center text-3xl font-bold md:text-4xl"
        >
          Local ${locationData.name} Advantage
        </h2>
        <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-4">
          {
            locationFeatures.map((feature, index) => {
              const FeatureIcon = feature.icon;
              return (
                <div key={index} class="text-center">
                  <div class="bg-primary/5 mb-4 inline-flex items-center justify-center rounded-lg p-3">
                    <FeatureIcon className="text-primary h-6 w-6" />
                  </div>
                  <h3 class="text-foreground mb-2 text-xl font-semibold">
                    {feature.title}
                  </h3>
                  <p class="text-muted-foreground text-sm">
                    {feature.description}
                  </p>
                </div>
              );
            })
          }
        </div>
      </div>
    </section>

    <!-- Service Benefits -->
    <section class="bg-muted/50 px-4 py-16 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-7xl">
        <h2
          class="text-foreground mb-12 text-center text-3xl font-bold md:text-4xl"
        >
          Why ${locationData.name} Businesses Choose Us
        </h2>
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
          <div>
            <h3 class="text-foreground mb-6 text-2xl font-semibold">
              Comprehensive ${service.data.title}
            </h3>
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <CheckCircle className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Proactive system monitoring and maintenance
                </p>
              </div>
              <div class="flex items-start gap-3">
                <CheckCircle className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  24/7 technical support and emergency response
                </p>
              </div>
              <div class="flex items-start gap-3">
                <CheckCircle className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Tailored solutions for ${locationData.state} business requirements
                </p>
              </div>
              <div class="flex items-start gap-3">
                <CheckCircle className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Regular performance reports and strategic reviews
                </p>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-foreground mb-6 text-2xl font-semibold">
              Regional Expertise
            </h3>
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <MapPin className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Serving ${
                    locationData.counties?.join(' and ') || 'Eastern Shore'
                  } counties
                </p>
              </div>
              <div class="flex items-start gap-3">
                <Clock className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Average response time under 2 hours for critical issues
                </p>
              </div>
              <div class="flex items-start gap-3">
                <Users className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Local team familiar with regional business challenges
                </p>
              </div>
              <div class="flex items-start gap-3">
                <TrendingUp className="text-primary mt-1 h-5 w-5 shrink-0" />
                <p class="text-muted-foreground">
                  Proven track record with ${locationData.region} businesses
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Nearby Locations -->
    {
      nearbyLocations.length > 0 && (
        <section class="px-4 py-16 sm:px-6 lg:px-8">
          <div class="mx-auto max-w-7xl">
            <h2 class="text-foreground mb-12 text-center text-3xl font-bold md:text-4xl">
              Also Serving Nearby ${locationData.state} Communities
            </h2>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
              {nearbyLocations.map((nearbyLoc, index) => (
                <Card key={index} className="text-center p-6">
                  <MapPin className="text-primary mx-auto mb-3 h-6 w-6" />
                  <h3 class="text-foreground font-semibold">
                    {nearbyLoc.data.name}
                  </h3>
                  <p class="text-muted-foreground text-sm">
                    {nearbyLoc.data.state}
                  </p>
                  <a
                    href={`/services/${serviceSlug}/${nearbyLoc.data.name.toLowerCase().replace(/\s+/g, '-')}`}
                    class="text-primary hover:text-primary/80 mt-3 text-sm font-medium"
                  >
                    View Services â†’
                  </a>
                </Card>
              ))}
            </div>
          </div>
        </section>
      )
    }

    <!-- CTA Section -->
    <section class="px-4 py-16 sm:px-6 lg:px-8">
      <div class="mx-auto max-w-4xl">
        <Card className="text-center" size="xl" interactive={false}>
          <h2 class="text-foreground mb-4 text-3xl font-bold md:text-4xl">
            Ready to Transform Your IT in {locationData.name}?
          </h2>
          <p class="text-muted-foreground mb-8 text-xl">
            Contact us today for a free consultation and see how our local
            expertise can benefit your business.
          </p>
          <div class="flex flex-col items-center gap-4 sm:flex-row">
            <a
              href="/contact"
              class="bg-primary text-primary-foreground hover:bg-primary/90 inline-flex cursor-pointer items-center gap-2 rounded-md px-8 py-3 text-sm font-medium shadow-sm transition-colors duration-300 hover:shadow-[--shadow-glow-sm]"
            >
              Schedule Consultation
              <Mail className="h-4 w-4" />
            </a>
            <a
              href="tel:410-555-0123"
              class="text-muted-foreground hover:text-foreground inline-flex items-center gap-2 text-sm font-medium transition-colors"
            >
              <Phone className="h-4 w-4" />
              Call (410) 555-0123
            </a>
          </div>
        </Card>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="relative px-4 py-12 sm:px-6 lg:px-8">
    <div
      class="relative z-10 mx-auto flex max-w-7xl flex-col items-center text-center"
    >
      <div>
        <Logo />
      </div>
      <p class="text-muted-foreground mb-4">
        Your trusted technology partner since 1999
      </p>
      <p class="text-muted-foreground/70 text-sm">
        &copy; {new Date().getFullYear()}
        <span class="font-display font-extrabold">BDKinc</span>. All rights
        reserved.
      </p>
    </div>
  </footer>
</Layout>
